<!DOCTYPE html>
<html lang="en">

<head>
      <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


  <title>The wayland project II</title>


  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
  <link href="/" rel="canonical" />

  <!-- Feed -->

  <link href="/theme/css/style.css" type="text/css" rel="stylesheet" />

  <!-- Code highlight color scheme -->
      <link href="/theme/css/code_blocks/github.css" rel="stylesheet">


  <!-- Custom fonts -->
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->


    <link href="/the-wayland-project-ii.html" rel="canonical" />

        <meta name="description" content="The last post I laid out the story of me with wayland. Technology is fascinating isn't it? Every once a while, there are plenty of new...">

        <meta name="author" content="Sichem Zhou">

        <meta name="tags" content="programming">




<!-- Open Graph -->
<meta property="og:site_name" content="InsaturÃ©"/>
<meta property="og:title" content="The wayland project II"/>
<meta property="og:description" content="The last post I laid out the story of me with wayland. Technology is fascinating isn't it? Every once a while, there are plenty of new..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/the-wayland-project-ii.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2018-11-30 00:00:00-05:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/sichem-zhou.html">
<meta property="article:section" content="Journal"/>
<meta property="article:tag" content="programming"/>
<meta property="og:image" content="/theme/images/post-bg.jpg">

<!-- Twitter Card -->

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "The wayland project II",
  "headline": "The wayland project II",
  "datePublished": "2018-11-30 00:00:00-05:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Sichem Zhou",
    "url": "/author/sichem-zhou.html"
  },
  "image": "/theme/images/post-bg.jpg",
  "url": "/the-wayland-project-ii.html",
  "description": "The last post I laid out the story of me with wayland. Technology is fascinating isn't it? Every once a while, there are plenty of new..."
}
</script>
</head>
<!-- TODO : Body class -->
<body class="home-template">

<nav id="menu">
  <a class="close-button">Close</a>
  <div class="nav-wrapper">
    <p class="nav-label">Menu</p>
    <ul>

              <li role="presentation"><a href="/pages/about-me.html">About Me</a></li>

    </ul>
  </div>
</nav>
    <!-- Progressbar -->
    <div class="progress-container">
        <span class="progress-bar"></span>
    </div>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header id="post-header" class="has-cover">
      <div class="inner">
        <nav id="navigation">
            <span id="home-button" class="nav-button">
                <a class="home-button" href="/" title="Home"><i class="ic ic-arrow-left"></i> Home</a>
            </span>
          <span id="menu-button" class="nav-button">
            <a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
          </span>
        </nav>
        <h1 class="post-title">The wayland project II</h1>
        <!-- TODO : Proper class for headline -->
        <span class="post-meta">
                <a href="/author/sichem-zhou.html">Sichem Zhou</a>
            | <time datetime="ven 30 novembre 2018">ven 30 novembre 2018</time>
        </span>
        <!-- TODO : Modified check -->
            <div class="post-cover cover" style="background-image: url('/theme/images/post-bg.jpg')">
      </div>
    </header>

  <section id="wrapper">
    <a class="hidden-close"></a>

    <!-- Post content -->
    <main class="content" role="main">
        <article class="post">
        <div class="inner">
            <section class="post-content">
                <p>The last <a href="/the-wayland-project.html">post</a> I laid out the story of me
with wayland. Technology is fascinating isn't it? Every once a while, there are
plenty of new projects that aim to start an revolution, getting people
excited. Projects like <strong>systemd</strong>, <strong>Wayland</strong>, <strong>Vulkan</strong> make us think how
come we did not think of those before, they seemed perfect at the
moment. Technologies always work like a rush of hot wave, our sights are limited
at the moment we are in, maybe 5 years from now, even <strong>vulkan</strong> is not sexy
anymore. For ten years, community has been urging everyone to jump on the boat
of wayland. Some major platform adopted it, just there is no money in it. Major
platforms like <strong>GNOME</strong> and <strong>KDE</strong> are not even mature yet, KDE developers
also worries about the future of the wayland, will it last 30 years like <strong>X
window</strong>?</p>
<p>One of the truth that almost nobody talks about is that we all try to advertize
the vague new technology as easy-to-learn, benifits and ignore all the learning
curves. Is it really so? How many simple ideas out there that can rock the
world? I cannot judge, in the context of <strong>wayland</strong> project. I cannot really
use the word <em>facile</em>. The knowledge required for a wayland compositor is far
more than what presented in
<a href="https://github.com/cdown/dwm/blob/master/dwm.c">DWM</a>. Wayland is merely a
<strong>IPC</strong> protocol library, all the work such as mapping hardware to logic
devices, rendering and compositing has to done by a compositor writer. Even with
the library <strong>libweston</strong>, programmers are still exposed by all those concepts.
If you step on the path to do it all yourself, you will need quite a massive
knowledge under the belt, I'd say. But let's not discourage everyone. Let's talk
about all the goodies of wayland tech, especially the <strong>libweston</strong> could offer.</p>
<h2>The input</h2>
<p>The first thing that I started with the <strong>libweston</strong> is actually learning
<strong>xkbcommon</strong>(xkbcommon itself has the concepts like <code>keymap</code>, <code>modifier</code>,
<code>keysym</code> and so on). I was trying to implement a complex keyboard mapping,
supporting sequence keybindings. It works a bit like what is available in emacs,
only I have to hack around the <code>libweston</code>'s flat keyboard handler. After
registering the keybinding callbacks, compositor will route the key events to
the clients when they are in focus.</p>
<p>Another idea exposed is the <strong>seat</strong>, it is presented in the wayland core
protocol as well. Unix system has this concept called <strong>seat</strong>. A seat is a set
of input device like keyboard, mice or controller, it means adding a seat for a
user to user, how to discouver and group input devices into seats is transparent
in the libweston, what programmer has is a signal handler. once a new seat
discovered, compositor can setup the <code>keymap</code> and other things.</p>
<h2>The view and surface</h2>
<p>The <code>view</code> and the <code>surface</code> are the core concept in the weston
composition. Basically <code>weston_surface</code> contains the buffer, but <code>weston_view</code>
determines where you will show the surface on the screen. In the current weston
architecture, at every frame, weston will build up a list of views and render
them on top of each other. You can play all kinds of tricks with view, like
rotations and scaling.</p>
<h2><code>weston_output</code> and <code>weston_layer</code></h2>
<p>The next concepts is the layer, this is idea when you want to futher seperate
compositing into layers of cake. For example, on the top of your layers, you
would have your cursor, then you may have some ui elements. futher downwards,
you may have your regular windows section, then at the bottom, there is the
wallpaper. If your GPU supports multiple planes, you can take the advantage of
it to composite only certain layers and leaves the rest unchange, your wouldn't
want to redraw everything just for the small motion of cursor, right :p?</p>
<p>What about <code>weston_output</code>? Output is the monitor, but technically it is a view
of your entire framebuffer. If you have two monitors side-by-side, one
output (monitor) occupies a chunk of that framebuffer. In this design, we only
need to composite one framebuffer, and you can move the windows from one monitor
to another at ease.</p>
<h2>Other wayland concepts</h2>
<p>Wayland object is not easy to work with, first challenge is double buffer
state. Manage the state is quite lines of code actually. Many other objects like
<code>registry</code> and <code>wl_global</code> or <code>wl_seat</code> are easier and usually done with a
common routine (I guess that is why you would want Qt/GTK instead of barebone
wayland client).</p>
<p>But The most confusing concept I've had is the <code>wl_surface_frame</code>. By reading the
wayland docs. Firstly I thought it was compulsory to do a buffer swap, once you
have your frame callback, you can do a rendering and commit. But if you really
do that, you would not be able to draw anything since <code>frame</code> only issues after
the <code>commit</code>. So you need to do a <code>wl_surface_frame</code>, then commit, then why do
you need the <code>wl_callback</code> later?  Just to delete it? This was how I drive my
wayland client for a long period. In turned out <code>wl_frame</code> is only useful for
the animations, but even though, you still need to have a first commit to drive
the next frame. If you are work with typical GUI element where you only need to
redraw at input events. The <code>frame</code> callback is totally unecessary. I <strong>only</strong>
realized it after reading through the libweston rendering pipeline.</p>
<p>So if you need to work on a wayland client, there are some traps like
this. Designing UIs under wayland is really far from easy, I would maybe write
another article about that part of the story.</p>
<h2>So after all, is it all good</h2>
<p>In the end, I have to say this. With help of libweston, the implemention of a
compositor is indeed much easier, it setup the <code>drm</code> and <code>gbm</code>, and implements
most of the core protocols like <code>wl_surface</code> <code>wl_buffer</code> on the sever side. What
it offers the compositor designer is a feature-rich apis to manipulate wayland
object, you can do almost everything you want. Only if you have a strong grasp
of all the concepts, so you can avoid all the traps that I as in. And
<strong>libweston</strong> has absolutely no documentation at all.</p>
<p>READ THE CODE! and go through a hell of debugging, you will get there in a year
or two.</p>
            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=The wayland project II&amp;url=/the-wayland-project-ii.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=/the-wayland-project-ii.html" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
                    </a>
                    <a class="googleplus" href="https://plus.google.com/share?url=/the-wayland-project-ii.html" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <i class="ic ic-googleplus"></i><span class="hidden">Google+</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="/tag/programming.html">programming</a>                </aside>

                <div class="clear"></div>


                </section>


                <aside class="post-nav">
                    <a class="post-nav-next" href="/realistic-deferred-msaa-implementation.html">
                        <section class="post-nav-teaser">
                            <i class="ic ic-arrow-left"></i>
                                <h2 class="post-nav-title">Realistic Deferred MSAA implementation</h2>
                            <p class="post-nav-excerpt">Deferred MSAA, always has been a good problem. In the spatial anti-aliasing domain,...</p>
                        </section>
                    </a>
                    <a class="post-nav-prev" href="/the-wayland-project.html">
                        <section class="post-nav-teaser">
                            <i class="ic ic-arrow-right"></i>
                                <h2 class="post-nav-title">The wayland project</h2>
                            <p class="post-nav-excerpt">It was a good will. 5 years ago, I read a blog about the future of linux desktop, I...</p>
                        </section>
                    </a>
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
      <!-- TODO : Body class -->
    <div id="body-class" style="display: none;" class=""></div>

    <footer id="footer">
      <div class="inner">
        <section class="credits">


          <span class="credits-theme">Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a></span>
          <span class="credits-software">Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a></span>
        </section>
      </div>
    </footer>
  </section>

  <script type="text/javascript" src="/theme/js/script.js"></script>

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-119901699-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>